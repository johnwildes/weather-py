{% extends "base.html" %}
{% block title %}Weather Forecast{% endblock %}

{% block content %}
<div class="forecast-content" id="forecastContent">
    {% if error_message %}
    <!-- Error Message Display -->
    <div class="error-state">
        <fluent-card class="error-card">
            <div class="error-content">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h3>Error Loading Weather Data</h3>
                <p>{{ error_message }}</p>
            </div>
        </fluent-card>
    </div>
    {% elif weather_data %}
    <!-- Current Weather Display -->
    <div class="current-weather-section">
        <fluent-card class="current-weather-card">
            <div class="current-weather-header">
                <div class="location-info">
                    <h2 class="city-name">{{ weather_data.location.name }}</h2>
                    <p class="region-country">{{ weather_data.location.region }}{% if weather_data.location.region and weather_data.location.country %}, {% endif %}{{ weather_data.location.country }}</p>
                </div>
                <div class="current-temp-display">
                    <div class="temp-unit-toggle">
                        <span class="unit-label" data-unit="celsius">¬∞C</span>
                        <fluent-switch id="tempUnitToggle" aria-label="Toggle temperature unit"></fluent-switch>
                        <span class="unit-label" data-unit="fahrenheit">¬∞F</span>
                    </div>
                    <img src="https:{{ weather_data.current.condition.icon }}" 
                         alt="{{ weather_data.current.condition.text }}" 
                         class="current-condition-icon" />
                    <span class="current-temp" 
                          data-temp-c="{{ weather_data.current.temp_c }}" 
                          data-temp-f="{{ weather_data.current.temp_f }}">{{ weather_data.current.temp_c }}¬∞C</span>
                </div>
            </div>
            <div class="current-weather-details">
                <p class="condition-text">{{ weather_data.current.condition.text }}</p>
                <div class="weather-stats">
                    <div class="stat-item">
                        <span class="stat-label">Feels like</span>
                        <span class="stat-value temp-value" 
                              data-temp-c="{{ weather_data.current.feelslike_c }}" 
                              data-temp-f="{{ weather_data.current.feelslike_f }}">{{ weather_data.current.feelslike_c }}¬∞C</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Humidity</span>
                        <span class="stat-value">{{ weather_data.current.humidity }}%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Wind</span>
                        <span class="stat-value">{{ weather_data.current.wind_kph }} km/h</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Visibility</span>
                        <span class="stat-value">{{ weather_data.current.vis_km }} km</span>
                    </div>
                </div>
            </div>
        </fluent-card>
    </div>

    <!-- Safety Metrics Section (moved after forecast) -->
    <div class="safety-metrics-section">
        {% if weather_data.uv_info %}
        <fluent-card class="safety-card uv-card">
            <div class="safety-header">
                <span class="safety-icon">‚òÄÔ∏è</span>
                <h3 class="safety-title">UV Index</h3>
            </div>
            <div class="safety-content">
                <div class="safety-value-display">
                    <span class="safety-value" style="color: {{ weather_data.uv_info.color }};">{{ weather_data.uv_info.value }}</span>
                    <span class="safety-level" style="background-color: {{ weather_data.uv_info.color }};">{{ weather_data.uv_info.level }}</span>
                </div>
                <p class="safety-recommendation">{{ weather_data.uv_info.recommendation }}</p>
            </div>
        </fluent-card>
        {% endif %}

        {% if weather_data.aqi_info %}
        <fluent-card class="safety-card aqi-card">
            <div class="safety-header">
                <span class="safety-icon">üå´Ô∏è</span>
                <h3 class="safety-title">Air Quality</h3>
            </div>
            <div class="safety-content">
                <div class="safety-value-display">
                    <span class="safety-level" style="background-color: {{ weather_data.aqi_info.color }};">{{ weather_data.aqi_info.level }}</span>
                </div>
                <p class="safety-recommendation">{{ weather_data.aqi_info.guidance }}</p>
                <div class="aqi-details">
                    <div class="aqi-stat">
                        <span class="aqi-label">PM2.5:</span>
                        <span class="aqi-value">{{ "%.1f"|format(weather_data.aqi_info.pm2_5 or 0) }} ¬µg/m¬≥</span>
                    </div>
                    <div class="aqi-stat">
                        <span class="aqi-label">PM10:</span>
                        <span class="aqi-value">{{ "%.1f"|format(weather_data.aqi_info.pm10 or 0) }} ¬µg/m¬≥</span>
                    </div>
                </div>
            </div>
        </fluent-card>
        {% endif %}
    </div>

    <!-- 10-Day Forecast Section -->
    {% if weather_data.forecast and weather_data.forecast.forecastday %}
    <div class="forecast-section">
        <fluent-card class="forecast-card">
            <h3 class="forecast-title">10-Day Forecast</h3>
            <div class="forecast-list">
                {% for day in weather_data.forecast.forecastday %}
                <div class="forecast-day-row">
                    <div class="day-info">
                        <span class="day-name">{{ day.date | format_date }}</span>
                        <span class="day-date">{{ day.date }}</span>
                    </div>
                    <div class="day-condition">
                        <img src="https:{{ day.day.condition.icon }}" 
                             alt="{{ day.day.condition.text }}" 
                             class="forecast-icon" />
                        <span class="condition-text">{{ day.day.condition.text }}</span>
                    </div>
                    <div class="day-temps">
                        <span class="temp-high temp-value" 
                              data-temp-c="{{ day.day.maxtemp_c }}" 
                              data-temp-f="{{ day.day.maxtemp_f }}">{{ day.day.maxtemp_c }}¬∞</span>
                        <div class="temp-bar">
                            {% set temp_width = ((day.day.maxtemp_c - day.day.mintemp_c) / 30 * 100)|int %}
                            <div class="temp-bar-fill" style="width: {{ [[temp_width, 0]|max, 100]|min }}%;"></div>
                        </div>
                        <span class="temp-low temp-value" 
                              data-temp-c="{{ day.day.mintemp_c }}" 
                              data-temp-f="{{ day.day.mintemp_f }}">{{ day.day.mintemp_c }}¬∞</span>
                    </div>
                    <div class="day-rain">
                        {% if day.day.daily_chance_of_rain > 0 %}
                        <span class="rain-chance">{{ day.day.daily_chance_of_rain }}%</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </fluent-card>
    </div>
    {% endif %}


    <!-- Safety Features Section (moved after forecast) -->
    {% if weather_data.alerts_info %}
    <div class="alerts-section">
        {% for alert in weather_data.alerts_info %}
        <fluent-card class="alert-card collapsed" style="border-left: 8px solid {{ alert.color }};">
            <div class="alert-header" onclick="toggleAlertCard(this)">
                <span class="alert-icon">{{ alert.icon }}</span>
                <h3 class="alert-headline">{{ alert.headline }}</h3>
                <span class="alert-toggle-icon">‚ñº</span>
            </div>
            <div class="alert-details">
                <div class="alert-meta">
                    <span class="alert-severity" style="color: {{ alert.color }};">{{ alert.severity }}</span>
                    <span class="alert-urgency">{{ alert.urgency }}</span>
                </div>
                <p class="alert-description">{{ alert.description }}</p>
                {% if alert.instruction %}
                <div class="alert-instruction">
                    <strong>‚ö†Ô∏è Safety Instructions:</strong> {{ alert.instruction }}
                </div>
                {% endif %}
            </div>
        </fluent-card>
        {% endfor %}
    </div>
    {% endif %}


    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <fluent-card class="empty-card">
            <div class="empty-content">
                <div class="empty-icon">üå§Ô∏è</div>
                <h3>Search for a location</h3>
                <p>Enter a city name or zip code above to see the weather forecast.</p>
            </div>
        </fluent-card>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleAlertCard(header) {
    const card = header.closest('.alert-card');
    card.classList.toggle('collapsed');
}

// Store current weather data for chat agent context
{% if weather_data %}
window.currentWeatherData = {
    location: {
        name: {{ weather_data.location.name | tojson }},
        region: {{ weather_data.location.region | tojson }},
        country: {{ weather_data.location.country | tojson }}
    },
    current: {
        temp_c: {{ weather_data.current.temp_c }},
        temp_f: {{ weather_data.current.temp_f }},
        feelslike_c: {{ weather_data.current.feelslike_c }},
        feelslike_f: {{ weather_data.current.feelslike_f }},
        humidity: {{ weather_data.current.humidity }},
        wind_kph: {{ weather_data.current.wind_kph }},
        wind_mph: {{ weather_data.current.wind_mph | default(0) }},
        vis_km: {{ weather_data.current.vis_km }},
        condition: {
            text: {{ weather_data.current.condition.text | tojson }}
        },
        uv: {{ weather_data.current.uv | default(0) }},
        pressure_mb: {{ weather_data.current.pressure_mb | default(1013) }}
    },
    forecast: {{ weather_data.forecast | tojson }}
    {% if weather_data.uv_info %},
    uv_info: {
        value: {{ weather_data.uv_info.value }},
        level: {{ weather_data.uv_info.level | tojson }},
        recommendation: {{ weather_data.uv_info.recommendation | tojson }}
    }
    {% endif %}
    {% if weather_data.aqi_info %},
    aqi_info: {
        level: {{ weather_data.aqi_info.level | tojson }},
        guidance: {{ weather_data.aqi_info.guidance | tojson }},
        pm2_5: {{ weather_data.aqi_info.pm2_5 | default(0) }},
        pm10: {{ weather_data.aqi_info.pm10 | default(0) }}
    }
    {% endif %}
    {% if weather_data.alerts_info %},
    alerts: {{ weather_data.alerts_info | tojson }}
    {% endif %}
};
{% else %}
window.currentWeatherData = null;
{% endif %}

// Temperature Unit Toggle
(function() {
    const toggle = document.getElementById('tempUnitToggle');
    if (!toggle) return;

    const STORAGE_KEY = 'weather_temp_unit';
    const celsiusLabel = document.querySelector('.unit-label[data-unit="celsius"]');
    const fahrenheitLabel = document.querySelector('.unit-label[data-unit="fahrenheit"]');

    // Load saved preference
    const savedUnit = localStorage.getItem(STORAGE_KEY) || 'celsius';
    const isFahrenheit = savedUnit === 'fahrenheit';
    toggle.checked = isFahrenheit;
    updateTemperatures(isFahrenheit);
    updateLabels(isFahrenheit);

    // Listen for toggle changes
    toggle.addEventListener('change', function() {
        const useFahrenheit = toggle.checked;
        localStorage.setItem(STORAGE_KEY, useFahrenheit ? 'fahrenheit' : 'celsius');
        updateTemperatures(useFahrenheit);
        updateLabels(useFahrenheit);
    });

    function updateLabels(useFahrenheit) {
        if (celsiusLabel && fahrenheitLabel) {
            celsiusLabel.classList.toggle('active', !useFahrenheit);
            fahrenheitLabel.classList.toggle('active', useFahrenheit);
        }
    }

    function updateTemperatures(useFahrenheit) {
        // Update main temperature display
        const mainTemp = document.querySelector('.current-temp');
        if (mainTemp) {
            const tempC = parseFloat(mainTemp.dataset.tempC);
            const tempF = parseFloat(mainTemp.dataset.tempF);
            mainTemp.textContent = useFahrenheit ? `${tempF}¬∞F` : `${tempC}¬∞C`;
        }

        // Update all temp-value elements (feels like, forecast highs/lows)
        document.querySelectorAll('.temp-value').forEach(el => {
            const tempC = parseFloat(el.dataset.tempC);
            const tempF = parseFloat(el.dataset.tempF);
            // Check if it's a forecast temp (no unit suffix) or other (with unit suffix)
            const isForecastTemp = el.classList.contains('temp-high') || el.classList.contains('temp-low');
            if (isForecastTemp) {
                el.textContent = useFahrenheit ? `${tempF}¬∞` : `${tempC}¬∞`;
            } else {
                el.textContent = useFahrenheit ? `${tempF}¬∞F` : `${tempC}¬∞C`;
            }
        });
    }
})();
</script>
{% endblock %}
